<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Game T√†i X·ªâu ·∫¢o Auto Li√™n T·ª•c</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg, #1b1b1b, #2c2c2c);
  color: #ffffff;
  margin: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

h1 {
  margin-bottom: 10px;
  font-size: 28px;
  font-weight: 700;
  text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3);
}

.balance {
  margin-bottom: 5px;
  font-size: 18px;
  font-weight: 600;
  color: #00ff88;
  text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
}

.current-bet {
  margin-bottom: 5px;
  font-size: 16px;
  color: #ffd700;
  text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
}

#betConfirm {
  margin-bottom: 10px;
  color: #00ff88;
  font-weight: 600;
  text-shadow: 0 0 5px rgba(0, 255, 136, 0.7);
}

.game-container {
  position: relative;
  width: 500px;
  height: 350px;
  border: 2px solid #555;
  border-radius: 15px;
  background: linear-gradient(145deg, #333, #222) url('images/table.png') no-repeat center/contain;
  margin-bottom: 20px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 255, 255, 0.1);
  overflow: hidden;
  background-blend-mode: overlay;
  touch-action: none; /* prevent default gestures interfering with drag */
}

.round-display {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 16px;
  font-weight: 600;
  color: #ffcc00;
  background: rgba(0, 0, 0, 0.6);
  padding: 5px 10px;
  border-radius: 5px;
  z-index: 5;
  text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
}

.dice-layer {
  position: absolute;
  top: 60px;
  left: 50%;
  width: 140px;
  height: 120px;
  transform: translateX(-50%);
  z-index: 4;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.5s ease;
}

.dice-layer img {
  position: absolute;
  width: 60px;
  height: 60px;
  filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7)) brightness(1.1);
}

.dice-layer img:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); }
.dice-layer img:nth-child(2) { bottom: 0; left: 0; }
.dice-layer img:nth-child(3) { bottom: 0; right: 0; }

.particle {
  position: absolute;
  width: 4px;
  height: 4px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 50%;
  pointer-events: none;
  z-index: 5;
  animation: particleFade 1s ease-out forwards;
}

@keyframes particleFade {
  0% { opacity: 0.8; transform: scale(1); }
  100% { opacity: 0; transform: scale(0.5) translateY(-50px); }
}

.result-label {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 24px;
  font-weight: 700;
  color: #ffd700;
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.4);
  z-index: 5;
  opacity: 0;
  transition: opacity 0.5s ease;
  animation: glow 1.5s infinite alternate;
}

@keyframes glow {
  0% { text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.4); }
  100% { text-shadow: 0 0 15px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 215, 0, 0.6); }
}

.bowl-layer {
  position: absolute;
  top: 30px;
  left: 50%;
  width: 280px;
  height: 170px;
  background: url('images/bowl.png') no-repeat center/contain;
  transform: translateX(-50%);
  cursor: grab;
  z-index: 6;
  transition: top 0.2s, left 0.2s, filter 0.3s;
  filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.4));
  touch-action: none; /* ensure we receive touch events */
}

.bowl-layer.active {
  filter: drop-shadow(0 0 15px rgba(0, 255, 136, 0.7)) brightness(1.1);
}

@keyframes shakeBowl {
  0% { transform: translateX(-50%) rotate(0deg); }
  25% { transform: translateX(-50%) rotate(2deg); }
  50% { transform: translateX(-50%) rotate(-2deg); }
  75% { transform: translateX(-50%) rotate(2deg); }
  100% { transform: translateX(-50%) rotate(0deg); }
}

.bowl-layer.shake {
  animation: shakeBowl 0.1s infinite;
}

/* ... (rest of CSS unchanged, omitted for brevity in this snippet) ... */
/* We'll keep the rest of your original CSS, including bet-options, reset-bet, quick-bet, recharging, music, history, media queries for max-width:600px, jumpDice, bowl animations, etc. */
  
/* Keep original styles below (copied exactly) */
.bet-options {
  position: absolute;
  top: 45%;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 60px;
  box-sizing: border-box;
  z-index: 5;
}
.bet-options button {
  padding: 12px 24px;
  font-size: 18px;
  font-weight: 600;
  border-radius: 10px;
  border: none;
  background: linear-gradient(45deg, #ff4444, #ff7777);
  color: #fff;
  cursor: pointer;
  transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}
.bet-options button:hover {
  background: linear-gradient(45deg, #ff7777, #ff9999);
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
}
.bet-options button#betXiu {
  background: linear-gradient(45deg, #4444ff, #7777ff);
}
.bet-options button#betXiu:hover {
  background: linear-gradient(45deg, #7777ff, #9999ff);
  box-shadow: 0 0 15px rgba(68, 68, 255, 0.5);
}
.reset-bet {
  position: absolute;
  bottom: 10px;
  left: 10px;
  padding: 8px 15px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  background: linear-gradient(45deg, #ffaa00, #ffcc33);
  color: #fff;
  cursor: pointer;
  transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  z-index: 5;
}
.reset-bet:hover {
  background: linear-gradient(45deg, #ffcc33, #ffdd66);
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(255, 170, 0, 0.5);
}
.quick-bet {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
  z-index: 5;
}
.quick-bet .quick-btn {
  padding: 8px 15px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  background: linear-gradient(45deg, #444, #666);
  color: #fff;
  transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}
.quick-bet .quick-btn:hover {
  background: linear-gradient(45deg, #666, #888);
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
}
#rechargeContainer {
  position: absolute;
  top: 20px;
  right: 20px;
  text-align: right;
}
#showRecharge {
  padding: 8px 15px;
  font-size: 14px;
  border-radius: 8px;
  border: none;
  background: linear-gradient(45deg, #00cc66, #00ff88);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  transition: transform 0.2s, box-shadow 0.2s;
}
#showRecharge:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
}
#rechargeQuick {
  display: none;
  margin-top: 10px;
}
.recharge-btn {
  padding: 8px 15px;
  font-size: 14px;
  cursor: pointer;
  border-radius: 8px;
  border: none;
  background: linear-gradient(45deg, #00cc66, #00ff88);
  color: #fff;
  margin-right: 5px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  transition: transform 0.2s, box-shadow 0.2s;
}
.recharge-btn:hover {
  background: linear-gradient(45deg, #00ff88, #33ffaa);
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
}
#toggleMusic {
  position: absolute;
  top: 100px;
  right: 20px;
  padding: 8px 15px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  background: linear-gradient(45deg, #00ccff, #0099ff);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  transition: transform 0.2s, box-shadow 0.2s;
  z-index: 10;
}
#toggleMusic:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(0, 204, 255, 0.5);
}
#toggleMusic.disabled {
  background: linear-gradient(45deg, #666, #888);
  cursor: not-allowed;
}
#downloadHistory {
  position: absolute;
  top: 140px;
  right: 20px;
  padding: 8px 15px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  background: linear-gradient(45deg, #ff4444, #ff7777);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  transition: transform 0.2s, box-shadow 0.2s;
  z-index: 10;
}
#downloadHistory:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
}
.countdown {
  position: absolute;
  top: 210px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 48px;
  font-weight: 700;
  color: #ffd700;
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.4);
  z-index: 7;
}
@keyframes jumpDice {
  0% { transform: translateY(0) scale(1); }
  20% { transform: translateY(-30px) scale(1.05); }
  40% { transform: translateY(-50px) scale(1.1); }
  60% { transform: translateY(-20px) scale(1.05); }
  80% { transform: translateY(0) scale(1.02); }
  100% { transform: translateY(0) scale(1); }
}
.jump {
  animation: jumpDice 0.8s cubic-bezier(0.36, 0.66, 0.04, 1);
}
/* bowl jump animations (left/right/up) kept exactly as original (not repeated here to save space) */
.history-dots {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  z-index: 5;
}
.history-dots .dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #ff4444;
  box-shadow: 0 0 5px rgba(255, 68, 68, 0.7), 0 0 10px rgba(255, 68, 68, 0.4);
}
.history-dots .dot.xiu {
  background: #4444ff;
  box-shadow: 0 0 5px rgba(68, 68, 255, 0.7), 0 0 10px rgba(68, 68, 255, 0.4);
}
.history-detail {
  position: absolute;
  top: 40px;
  left: 10px;
  font-size: 12px;
  display: none;
  flex-direction: column;
  max-height: 150px;
  width: 120px;
  overflow-y: auto;
  background: rgba(0, 0, 0, 0.6);
  padding: 5px;
  border-radius: 5px;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
  z-index: 5;
}
.history-detail span {
  margin-bottom: 3px;
  padding: 2px 5px;
  border-radius: 3px;
  color: #fff;
}
#toggleHistory {
  position: absolute;
  top: 10px;
  left: 10px;
  padding: 5px 10px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 5px;
  border: none;
  background: linear-gradient(45deg, #444, #666);
  color: #fff;
  cursor: pointer;
  transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  z-index: 5;
}
#toggleHistory:hover {
  background: linear-gradient(45deg, #666, #888);
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
}

/* Responsive mobile tweaks (existing) */
@media (max-width: 600px) {
  .game-container {
    width: 90%;
    height: 300px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.1);
  }
  .bowl-layer {
    width: 240px;
    height: 140px;
    top: 20px;
  }
  .dice-layer {
    width: 120px;
    height: 100px;
    top: 50px;
  }
  .dice-layer img {
    width: 50px;
    height: 50px;
  }
  .result-label {
    font-size: 20px;
    top: 15px;
  }
  .bet-options {
    top: 40%;
    padding: 0 40px;
  }
  .bet-options button {
    padding: 8px 16px;
    font-size: 14px;
  }
  .quick-bet {
    bottom: 30px;
  }
  .quick-bet .quick-btn, .recharge-btn, .reset-bet, #toggleMusic, #downloadHistory {
    padding: 6px 10px;
    font-size: 12px;
  }
  .round-display {
    font-size: 14px;
    padding: 4px 8px;
  }
  .countdown {
    font-size: 36px;
    top: 180px;
  }
  .history-detail {
    width: 100px;
    top: 40px;
  }
  #toggleHistory {
    font-size: 12px;
    padding: 4px 8px;
  }
}

/* New: orientation-specific styles for mobile landscape */
@media only screen and (max-width: 900px) and (orientation: landscape) {
  .game-container {
    height: 220px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .bowl-layer {
    width: 210px;
    height: 120px;
    top: 10px;
  }
  .dice-layer { top: 40px; width: 110px; height: 90px; }
  .countdown { top: 140px; font-size: 30px; }
  .bet-options { top: 55%; padding: 0 20px; }
  .quick-bet { bottom: 18px; }
  #rechargeContainer, #toggleMusic, #downloadHistory {
    right: 10px;
  }
}
</style>
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<h1>Game T√†i X·ªâu ·∫¢o</h1>
<div class="balance" id="balanceDisplay">Balance: 1.000 ‚Ç´</div>
<div class="current-bet" id="currentBetDisplay">T·ªïng c∆∞·ª£c hi·ªán t·∫°i: 0 ‚Ç´</div>
<div id="betConfirm"></div>

<div id="rechargeContainer">
  <button id="showRecharge">N·∫°p ti·ªÅn</button>
  <div id="rechargeQuick">
    <button class="recharge-btn" data-amount="1000000">1m</button>
    <button class="recharge-btn" data-amount="5000000">5m</button>
    <button class="recharge-btn" data-amount="100000000">100m</button>
  </div>
</div>

<div class="game-container" id="gameContainer">
  <div class="dice-layer" id="diceLayer">
    <img src="images/dice1.png" alt="Dice 1">
    <img src="images/dice2.png" alt="Dice 2">
    <img src="images/dice3.png" alt="Dice 3">
  </div>
  <div class="result-label" id="resultLabel"></div>
  <div class="bowl-layer" id="bowlLayer"></div>
  <div class="bet-options">
    <button id="betTai">T√†i</button>
    <button id="betXiu">X·ªâu</button>
  </div>
  <div class="countdown" id="countdownDisplay"></div>
  <div class="quick-bet">
    <button class="quick-btn" data-amount="1000">1k</button>
    <button class="quick-btn" data-amount="10000">10k</button>
    <button class="quick-btn" data-amount="100000">100k</button>
    <button class="quick-btn" data-amount="500000">500k</button>
    <button class="quick-btn" data-amount="1000000">1m</button>
    <button class="quick-btn" data-amount="5000000">5m</button>
    <button class="quick-btn" data-amount="all">All-in</button>
  </div>
  <button class="reset-bet" id="resetBet">Reset C∆∞·ª£c</button>
  <div class="round-display" id="roundDisplay">V√≤ng: 0</div>
  <div class="history-dots" id="historyDots"></div>
  <button id="toggleHistory">L·ªãch s·ª≠</button>
  <div class="history-detail" id="historyDetail"><div style="font-weight:bold;margin-bottom:3px;">L·ªãch s·ª≠ chi ti·∫øt</div></div>
</div>

<audio id="bgMusic" loop>
  <source src="sounds/background.mp3" type="audio/mpeg">
  <source src="sounds/background.ogg" type="audio/ogg">
  Your browser does not support the audio element.
</audio>
<audio id="diceSound">
  <source src="sounds/dice.mp3" type="audio/mpeg">
  <source src="sounds/dice.ogg" type="audio/ogg">
  Your browser does not support the audio element.
</audio>
<button id="toggleMusic">üéµ Nh·∫°c: T·∫Øt</button>
<button id="downloadHistory">üì• T·∫£i l·ªãch s·ª≠</button>

<script>
/* ======================
   PH·∫¶N JS NGUY√äN G·ªêC + C·∫¢I TI·∫æN CHO TOUCH & ORIENTATION
   - Gi·ªØ nguy√™n logic g·ªëc c·ªßa b·∫°n
   - Th√™m touchstart/touchmove/touchend ƒë·ªÉ k√©o b√°t tr√™n ƒëi·ªán tho·∫°i
   - S·ª≠a c√°ch x·ª≠ l√Ω left/transform trong l√∫c k√©o ƒë·ªÉ tr√°nh l·ªách
   ====================== */

let balance=1000000, bet=null, betAmount=0;
let currentRound=0, phase='bet', countdown=30, countdownInterval;
let bowlOpened=false, finalDice=[], result='';
let historyData=[["Round","Dice","Result","Bet","Bet Amount","Balance"]];
let balanceDisplay=document.getElementById('balanceDisplay'),
    currentBetDisplay=document.getElementById('currentBetDisplay'),
    countdownDisplay=document.getElementById('countdownDisplay'),
    roundDisplay=document.getElementById('roundDisplay'),
    betConfirm=document.getElementById('betConfirm'),
    historyDotsContainer=document.getElementById('historyDots'),
    historyDetailContainer=document.getElementById('historyDetail'),
    toggleHistory=document.getElementById('toggleHistory'),
    bowl=document.getElementById('bowlLayer'),
    diceLayer=document.getElementById('diceLayer'),
    resultLabel=document.getElementById('resultLabel'),
    gameContainer=document.getElementById('gameContainer'),
    music=document.getElementById('bgMusic'),
    diceSound=document.getElementById('diceSound'),
    toggleBtn=document.getElementById('toggleMusic'),
    downloadHistoryBtn=document.getElementById('downloadHistory');
let playing=false;

function formatVND(a){return a.toLocaleString('vi-VN',{style:'currency',currency:'VND',minimumFractionDigits:0});}
function updateBalance(){balanceDisplay.textContent=`Balance: ${formatVND(balance)}`;}
function updateCurrentBet(){currentBetDisplay.textContent=`T·ªïng c∆∞·ª£c hi·ªán t·∫°i: ${formatVND(betAmount)}`;}
function updateRoundDisplay(){roundDisplay.textContent=`V√≤ng: ${currentRound}`;}

function jumpDiceEffect(){
    let diceImgs=document.querySelectorAll('.dice-layer img');
    diceImgs.forEach(img=>{ img.classList.remove('jump'); void img.offsetWidth; img.classList.add('jump'); });
    createParticles();
    if(!diceSound.paused) diceSound.currentTime=0;
    diceSound.play().catch(err=>console.warn('Dice sound playback failed:',err));
}

function showFinalDice(){
    diceLayer.style.opacity=1;
    document.querySelectorAll('.dice-layer img').forEach((img,i)=>{img.src=`images/dice${finalDice[i]}.png`});
    resultLabel.textContent=result;
    resultLabel.style.opacity=1;
}

function hideResultLabel(){
    resultLabel.style.opacity=0;
    resultLabel.textContent='';
}

function addHistoryDot(res){
    let dot=document.createElement('div'); dot.classList.add('dot'); if(res==='X·ªâu') dot.classList.add('xiu');
    historyDotsContainer.appendChild(dot);
    if(historyDotsContainer.children.length>15) historyDotsContainer.removeChild(historyDotsContainer.children[0]);
}

function addHistoryDetail(res,dice){
    let span=document.createElement('span'); span.textContent=`#${currentRound}: ${res} (${dice.join(',')})`;
    span.style.background=res==='T√†i'?'red':'blue';
    historyDetailContainer.appendChild(span);
    if(historyDetailContainer.children.length>16) historyDetailContainer.removeChild(historyDetailContainer.children[1]);
}

function logHistory(){
    historyData.push([currentRound,finalDice.join(','),result,bet||'None',betAmount,balance]);
}

function downloadHistory(){
    if(typeof XLSX==='undefined') {
        console.warn('XLSX library not loaded');
        return;
    }
    const ws=XLSX.utils.aoa_to_sheet(historyData);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'GameHistory');
    XLSX.writeFile(wb,'TaiXiuHistory.xlsx');
}

function createParticles(){
    for(let i=0;i<10;i++){
        let particle=document.createElement('div');
        particle.classList.add('particle');
        let x=70+Math.random()*60;
        let y=60+Math.random()*60;
        particle.style.left=`${x}px`;
        particle.style.top=`${y}px`;
        particle.style.animationDelay=`${Math.random()*0.5}s`;
        diceLayer.appendChild(particle);
        setTimeout(()=>{particle.remove();},1000);
    }
}

/* ====== openBowl: gi·ªØ logic g·ªëc nh∆∞ng ƒë·∫£m b·∫£o reset v·ªã tr√≠ b√°t ·ªïn ƒë·ªãnh ====== */
function openBowl(){
    if(bowlOpened) return;
    bowlOpened=true;

    addHistoryDot(result);
    addHistoryDetail(result,finalDice);
    logHistory();
    if(bet && betAmount>0){
        if(bet===result) balance+=betAmount;
        else balance-=betAmount;
        updateBalance();
    }

    const directions=['left','right','up'];
    const randomDirection=directions[Math.floor(Math.random()*directions.length)];
    bowl.classList.add(`bowl-jump-${randomDirection}`);

    setTimeout(()=>{
        // reset v·ªã tr√≠ b√°t v·ªÅ gi·ªØa ·ªïn ƒë·ªãnh
        bowl.style.transition = 'left 0.3s, top 0.3s';
        bowl.style.left = '50%';
        bowl.style.top = '30px';
        bowl.style.transform = 'translateX(-50%)';
        setTimeout(()=>{
          bowl.style.transition = ''; // remove transition
        },350);

        bowl.classList.remove(`bowl-jump-left`,`bowl-jump-right`,`bowl-jump-up`);
        bet=null;
        betAmount=0;
        updateCurrentBet();
        betConfirm.textContent='';
        hideResultLabel();
        startPhase(30,'bet');
    },3000);
}

/* ====== startPhase (gi·ªØ nguy√™n) ====== */
function startPhase(time,phaseName){
    phase=phaseName; countdown=time;
    if(phase==='bet'){
        countdownDisplay.style.display='block';
        bowl.classList.remove('active');
        diceLayer.style.opacity=0;
        hideResultLabel();
    } else {
        countdownDisplay.style.display='none';
        bowl.classList.add('active');
    }
    clearInterval(countdownInterval);

    if(phase==='bet'){
        currentRound++; bowlOpened=false; finalDice=[]; bet=null; betAmount=0; betConfirm.textContent='';
        updateCurrentBet(); updateRoundDisplay();
    }

    if(phase==='open'){
        finalDice=[]; for(let i=0;i<3;i++) finalDice.push(Math.floor(Math.random()*6)+1);
        let total=finalDice.reduce((a,b)=>a+b,0);
        result=total>=11?'T√†i':'X·ªâu';
        showFinalDice();
        jumpDiceEffect();
    }

    countdownInterval=setInterval(()=>{
        countdown--;
        if(phase==='bet') countdownDisplay.textContent=countdown;
        if(countdown<=0){
            clearInterval(countdownInterval);
            if(phase==='bet') startPhase(10,'open');
            else if(phase==='open') openBowl();
        }
    },1000);
}

/* ====== Event listeners for betting, quick buttons, recharge, history ====== */
document.querySelectorAll('.quick-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
        if(phase!=='bet') return;
        let val=btn.dataset.amount==='all'?balance:parseInt(btn.dataset.amount);
        betAmount+=val; if(betAmount>balance) betAmount=balance;
        updateCurrentBet();
    });
});

document.getElementById('resetBet').addEventListener('click',()=>{
    if(phase==='bet'){
        betAmount=0;
        bet=null;
        betConfirm.textContent='';
        updateCurrentBet();
    }
});

document.getElementById('betTai').addEventListener('click',()=>{
    if(betAmount>0 && phase==='bet'){
        bet='T√†i';
        betConfirm.textContent=`B·∫°n ƒë√£ c∆∞·ª£c ${formatVND(betAmount)} v√†o T√†i`;
    }
});

document.getElementById('betXiu').addEventListener('click',()=>{
    if(betAmount>0 && phase==='bet'){
        bet='X·ªâu';
        betConfirm.textContent=`B·∫°n ƒë√£ c∆∞·ª£c ${formatVND(betAmount)} v√†o X·ªâu`;
    }
});

document.getElementById('showRecharge').addEventListener('click',()=>{
    let r=document.getElementById('rechargeQuick');
    r.style.display=r.style.display==='none'?'block':'none';
});

document.querySelectorAll('.recharge-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
        balance+=parseInt(btn.dataset.amount);
        updateBalance();
    });
});

toggleHistory.addEventListener('click',()=>{
    historyDetailContainer.style.display=historyDetailContainer.style.display==='none'?'flex':'none';
});

downloadHistoryBtn.addEventListener('click',downloadHistory);

/* ===========================
   Dragging: MOUSE + TOUCH
   - S·ª≠a ƒë·ªÉ ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh khi c√≥ transform:translateX(-50%)
   - Khi b·∫Øt ƒë·∫ßu k√©o: t√≠nh left px nguy√™n (khi k√©o ƒë·∫∑t transform = none)
   - Khi k·∫øt th√∫c: tr·∫£ transform v·ªÅ translateX(-50%) v√† left = '50%' (center) ho·∫∑c px n·∫øu ƒë∆∞·ª£c gi·ªØ ·ªü v·ªã tr√≠ ƒë√≥
   =========================== */

let isDragging=false;
let startX=0, startY=0;
let bowlStartLeft=0, bowlStartTop=0;
let shakeInterval=null;

/* Helper: get numeric left/top of bowl relative to container (px) */
function getBowlPos() {
    const rect = bowl.getBoundingClientRect();
    const containerRect = gameContainer.getBoundingClientRect();
    return {
        left: rect.left - containerRect.left,
        top: rect.top - containerRect.top
    };
}

/* Mouse handlers (gi·ªØ nguy√™n nh∆∞ng d√πng getBowlPos) */
bowl.addEventListener('mousedown', (e)=>{
    if(phase!=='open') return;
    isDragging=true;
    startX = e.clientX;
    startY = e.clientY;
    const pos = getBowlPos();
    bowlStartLeft = pos.left;
    bowlStartTop = pos.top;

    // while dragging, remove translateX(-50%) so left px is exact
    bowl.style.transform = 'translateX(0)';
    bowl.style.left = bowlStartLeft + 'px';
    bowl.style.top = bowlStartTop + 'px';

    bowl.style.cursor='grabbing';
    bowl.classList.add('shake');
    let offset=0;
    shakeInterval=setInterval(()=>{
        offset = offset===0?2:0;
        bowl.style.transform = `translate(${offset}px, ${offset}px)`;
    },50);
});

/* Mousemove -> drag */
document.addEventListener('mousemove', (e)=>{
    if(!isDragging) return;
    let dx = e.clientX - startX;
    let dy = e.clientY - startY;
    let newLeft = Math.min(Math.max(bowlStartLeft + dx, 0), gameContainer.clientWidth - bowl.clientWidth);
    let newTop = Math.min(Math.max(bowlStartTop + dy, 0), gameContainer.clientHeight - bowl.clientHeight - 110);
    bowl.style.left = newLeft + 'px';
    bowl.style.top = newTop + 'px';
});

/* Mouseup -> drop */
document.addEventListener('mouseup', (e)=>{
    if(!isDragging) return;
    isDragging=false;
    bowl.style.cursor='grab';
    bowl.classList.remove('shake');
    clearInterval(shakeInterval);
    // restore translateX(-50%) unless we want exact px position
    // compute center distance to decide open
    const containerCenterX = gameContainer.clientWidth / 2;
    const rect = bowl.getBoundingClientRect();
    const containerRect = gameContainer.getBoundingClientRect();
    const bowlLeftPx = rect.left - containerRect.left;
    const bowlCenterX = bowlLeftPx + bowl.clientWidth/2;
    const distance = Math.abs(bowlCenterX - containerCenterX);

    // restore transform for consistent visuals
    bowl.style.transform = 'translateX(-50%)';

    if(phase!=='open') return;
    if(distance < 80) {
        openBowl();
    } else {
        // If not opened, keep bowl at its px position but convert to percent if near center or reset to left value
        // We'll set left in px and keep translateX(-50%) only if we set left to 50%
        // So, to avoid weird shift, animate back to nearest allowed area:
        // If bowl was dragged somewhere, keep it there (use left px + transform none)
        // For simplicity, set left as px and remove translate to avoid sudden jumps:
        bowl.style.transform = 'translateX(0)';
        bowl.style.left = (Math.min(Math.max(bowlLeftPx,0), gameContainer.clientWidth - bowl.clientWidth)) + 'px';
        // After small timeout, restore translateX(-50%) and center if very close to center
        setTimeout(()=>{ bowl.style.transform = 'translateX(-50%)'; bowl.style.left = bowl.style.left; }, 50);
    }
});

/* ========== TOUCH EVENTS ========== */
/* Mirror mousedown/mousemove/mouseup for touch devices */
bowl.addEventListener('touchstart', (ev)=>{
    if(phase!=='open') return;
    const e = ev.touches[0];
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    const pos = getBowlPos();
    bowlStartLeft = pos.left;
    bowlStartTop = pos.top;

    bowl.style.transform = 'translateX(0)';
    bowl.style.left = bowlStartLeft + 'px';
    bowl.style.top = bowlStartTop + 'px';

    bowl.style.cursor='grabbing';
    bowl.classList.add('shake');
    let offset=0;
    shakeInterval=setInterval(()=>{
        offset = offset===0?2:0;
        bowl.style.transform = `translate(${offset}px, ${offset}px)`;
    },50);

    // prevent page scrolling while dragging
    ev.preventDefault();
}, {passive:false});

document.addEventListener('touchmove', (ev)=>{
    if(!isDragging) return;
    const e = ev.touches[0];
    let dx = e.clientX - startX;
    let dy = e.clientY - startY;
    let newLeft = Math.min(Math.max(bowlStartLeft + dx, 0), gameContainer.clientWidth - bowl.clientWidth);
    let newTop = Math.min(Math.max(bowlStartTop + dy, 0), gameContainer.clientHeight - bowl.clientHeight - 110);
    bowl.style.left = newLeft + 'px';
    bowl.style.top = newTop + 'px';
    ev.preventDefault();
}, {passive:false});

document.addEventListener('touchend', (ev)=>{
    if(!isDragging) return;
    isDragging=false;
    bowl.style.cursor='grab';
    bowl.classList.remove('shake');
    clearInterval(shakeInterval);

    const containerCenterX = gameContainer.clientWidth / 2;
    const rect = bowl.getBoundingClientRect();
    const containerRect = gameContainer.getBoundingClientRect();
    const bowlLeftPx = rect.left - containerRect.left;
    const bowlCenterX = bowlLeftPx + bowl.clientWidth/2;
    const distance = Math.abs(bowlCenterX - containerCenterX);

    bowl.style.transform = 'translateX(-50%)';

    if(phase!=='open') return;
    if(distance < 80) {
        openBowl();
    } else {
        bowl.style.transform = 'translateX(0)';
        bowl.style.left = (Math.min(Math.max(bowlLeftPx,0), gameContainer.clientWidth - bowl.clientWidth)) + 'px';
        setTimeout(()=>{ bowl.style.transform = 'translateX(-50%)'; bowl.style.left = bowl.style.left; }, 50);
    }
}, {passive:false});

/* Prevent touch on container from scrolling while interacting */
gameContainer.addEventListener('touchmove', (e)=>{ if(isDragging) e.preventDefault(); }, {passive:false});

/* ===== Audio handling (gi·ªØ nguy√™n) ===== */
music.addEventListener('error',()=>{
    console.warn('Failed to load audio file: sounds/background.mp3 or sounds/background.ogg');
    toggleBtn.textContent='üéµ Nh·∫°c: L·ªói';
    toggleBtn.classList.add('disabled');
    toggleBtn.disabled=true;
});

diceSound.addEventListener('error',()=>{
    console.warn('Failed to load audio file: sounds/dice.mp3 or sounds/dice.ogg');
});

music.addEventListener('canplay',()=>{
    document.body.addEventListener('click',()=>{
        if(!playing && !toggleBtn.disabled){
            music.play().then(()=>{
                playing=true;
                toggleBtn.textContent='üéµ Nh·∫°c: B·∫≠t';
            }).catch(err=>{
                console.warn('Audio playback failed:',err);
                toggleBtn.textContent='üéµ Nh·∫°c: L·ªói';
                toggleBtn.classList.add('disabled');
                toggleBtn.disabled=true;
            });
        }
    },{once:true});
});

toggleBtn.addEventListener('click',()=>{
    if(toggleBtn.disabled) return;
    if(playing){
        music.pause();
        toggleBtn.textContent='üéµ Nh·∫°c: T·∫Øt';
    }else{
        music.play().then(()=>{
            toggleBtn.textContent='üéµ Nh·∫°c: B·∫≠t';
        }).catch(err=>{
            console.warn('Audio playback failed:',err);
            toggleBtn.textContent='üéµ Nh·∫°c: L·ªói';
            toggleBtn.classList.add('disabled');
            toggleBtn.disabled=true;
        });
    }
    playing=!playing;
});

updateBalance(); updateCurrentBet(); updateRoundDisplay(); startPhase(30,'bet');

/* Optional: handle orientation change to tweak layout if needed */
window.addEventListener('orientationchange', ()=>{
  // small visual refresh / recalculation after rotate
  setTimeout(()=> {
    // ensure bowl remains within bounds
    const pos = getBowlPos();
    const maxLeft = Math.max(0, gameContainer.clientWidth - bowl.clientWidth);
    if(pos.left > maxLeft) {
      bowl.style.transform = 'translateX(0)';
      bowl.style.left = maxLeft + 'px';
      setTimeout(()=>{ bowl.style.transform='translateX(-50%)'; },50);
    }
  }, 300);
});
</script>
</body>
</html>
